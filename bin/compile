#!/usr/bin/env bash
set -e

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

# Ensure required directories exist
mkdir -p "$CACHE_DIR"

echo "-----> Installing MCP Auth Proxy"

# Read environment variables if ENV_DIR exists
if [[ -d "$ENV_DIR" ]]; then
  for env_var in MCP_PROXY_DOWNLOAD_METHOD MCP_PROXY_VERSION MCP_PROXY_GIT_REF; do
    if [[ -f "$ENV_DIR/$env_var" ]]; then
      export $env_var=$(cat "$ENV_DIR/$env_var")
    fi
  done
fi

# Source library functions
LIB_DIR="$(dirname $0)/../lib"
source "$LIB_DIR/version-resolver.sh"
source "$LIB_DIR/downloader.sh"
source "$LIB_DIR/installer.sh"

# Execute build process
resolve_version
download_proxy
install_proxy

echo "-----> MCP Auth Proxy installation complete"
if [[ "${MCP_PROXY_DOWNLOAD_METHOD:-release}" == "git" ]]; then
  echo "       Git Reference: $GIT_REF"
else
  echo "       Release Version: $VERSION"
fi
echo "       Download Method: ${MCP_PROXY_DOWNLOAD_METHOD:-release}"
